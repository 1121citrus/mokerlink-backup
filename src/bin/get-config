#!/usr/bin/env bash

bindir=$(readlink -f "$(dirname "${0}")")
export PATH=${bindir}:${PATH}

# shellcheck disable=SC1091
source /usr/local/include/bash/common-functions

is-true() {
    echo "${1}" | grep -E -i -q '^\s*(1|true|t|yes|y)\s*$' >/dev/null 2>&1
}
expect_args=$(is-true "${DEBUG:=false}" && echo -n -d)

function __show_config_raw__() {
    local config="${1:?Need configuration name}"
    local hostname="${2:?Need hostname}"
    local username="${3:?Need username}"
    local password="${4:?Need password}"
    /usr/bin/env expect ${expect_args} <<-__END_OF_SCRIPT__
log_user 0
set timeout -1
spawn ssh -F /dev/null -T -o LogLevel=quiet -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa -l ${username} ${hostname}
match_max 100000
expect "Username: "
send -- "${username}\r"
expect "Password: "
send -- "${password}\r"
expect "# "
send -- "terminal length 0\r"
expect "# "
send -- "show ${config}-config\r"
log_user 1
expect "# "
log_user 0
send -- "exit\r"
expect "> "
send -- "exit\r"
expect eof
__END_OF_SCRIPT__
}

config="${1:-running}"
config=$(echo "${config}" | tr '[:upper:]' '[:lower:]')
[[ "${config}" =~ ^(running|startup|backup)$ ]] || \
    error "unknown configuration: '${config}' -- expecting one of  'running', 'starting' or 'backup'"

host="${2:-${MOKERLINK_HOST:=${TAILSCALE_HOST:=}}}"
[[ -n "${host}" ]] || error 'need hostname, or set MOKERLINK_HOST or TAILSCALE_HOST environment variable'

user="${3:-${MOKERLINK_USER:=remote-backup}}"

password="${4:-}"
if [[ -z "${password}" ]]; then
    if [[ -n "${MOKERLINK_PASSWORD:=}" ]]; then
        password="${MOKERLINK_PASSWORD}"
    elif [[ -r "${MOKERLINK_PASSWORD_FILE:=/run/secrets/mokerlink-password}" ]]; then
        password=$(cat "${MOKERLINK_PASSWORD_FILE}")
    fi
fi
[[ -n "${password}" ]] || error 'need password, or set MOKERLINK_PASSWORD or MOKERLINK_PASSWORD_FILE (default: /run/secrets/mokerlink-password) environment variable'

# The raw output starts:
#     show ${config}-config
#     show ${config}-config
#     SYSTEM CONFIG FILE ::= BEGIN
# Remove the first two lines

__show_config_raw__ "${config}" "${host}" "${user}" "${password}" | tail -n +3

